//******************************************************************************
//* bqe.js: openwebif Bouqueteditor plugin
//* Version 1.0
//******************************************************************************
//* Copyright (C) 2014 Joerg Bleyel
//* Copyright (C) 2014 E2OpenPlugins
//*
//* Authors: Joerg Bleyel <jbleyel # gmx.net>
//* License GPL V2
//* https://github.com/E2OpenPlugins/e2openplugin-OpenWebif/blob/master/LICENSE.txt
//*******************************************************************************
// TODO: alternatives
function buildRefStr(e){var t=0===Mode?"1:7:1:0:0:0:0:0:0:0:(type == 1) || (type == 17) || (type == 195) || (type == 25) ":"1:7:2:0:0:0:0:0:0:0:(type == 2) ";return 0===e&&(t+='FROM BOUQUET "bouquets.',t+=0===Mode?"tv":"radio",t+='" ORDER BY bouquet'),1===e&&(t+="FROM PROVIDERS ORDER BY name"),2===e&&(t+="FROM SATELLITES ORDER BY satellitePosition"),3===e&&(t+="ORDER BY name"),console.log(t),encodeURIComponent(t)}function BQELoadTVR(e){var t=!1;(e!==Mode||3===e)&&(t=!0),e>1?(Mode=0,t=!0):Mode=e,0===cType&&BQELoadSatellites(),1===cType&&BQELoadProvider(),2===cType&&BQELoadAll(),t&&BQELoadBQ()}function BQELoadSatellites(){cType=0,$("#sel0").show(),$("#channels").empty(),srccl=[],selsrccl=[],SetCHButtons();var e=buildRefStr(2),t="";$.getJSON("/api/getsatellites?sRef="+e,function(e){var n=e.satellites;$.each(n,function(e,n){var r=n.service,s=n.name;t+="<li class='ui-widget-content' id='"+encodeURIComponent(r)+"'>"+s+"</li>"}),$("#provider").empty(),$("#provider").append(t),$("#provider").selectable().children().first().addClass("ui-selected");var r=$("#provider").selectable().children().first().attr("id");changeProvider(r)})}function BQELoadProvider(){cType=1,$("#sel0").show(),$("#channels").empty(),srccl=[],selsrccl=[],SetCHButtons();var e=buildRefStr(1),t="";$.getJSON("/api/getservices?sRef="+e,function(e){var n=e.services;$.each(n,function(e,n){var r=n.servicereference,s=n.servicename;t+="<li class='ui-widget-content' id='"+encodeURIComponent(r)+"'>"+s+"</li>"}),$("#provider").empty(),$("#provider").append(t),$("#provider").selectable().children().first().addClass("ui-selected");var r=$("#provider").selectable().children().first().attr("id");changeProvider(r)})}function BQELoadBQ(){var e=buildRefStr(0),t="";dstbl=[],seldstbl=[],SetBQButtons(),$.getJSON(rootreqstr+"getservices?sRef="+e,function(e){var n=e.services,r=0;$.each(n,function(e,n){dstbl.push(n);var s=n.servicename;t+="<li class='ui-widget-content' id='"+r+"'><div class='handle'><span class='ui-icon ui-icon-carat-2-n-s'></span></div>"+s+"</li>",r++}),$("#bql").empty(),$("#bql").append(t),$("#bql").selectable().children().first().addClass("ui-selected");var s=$("#bql").selectable().children().first().attr("id");SetBQButtons(),changeBQidx(s)})}function BQELoadAll(){$("#btnaddp").prop("disabled",!0),$("#sel0").hide(),cType=2;var e=buildRefStr(3),t="";srccl=[],selsrccl=[],SetCHButtons(),$.getJSON("/api/getservices?sRef="+e,function(e){var n=e.services;$.each(n,function(e,n){var r=n.servicename;t+="<li class='ui-widget-content'>"+r+"</li>",srccl.push(n)}),$("#channels").empty(),$("#channels").append(t)})}function changeBQidx(e){var t=parseInt(e),n=dstbl[t].servicereference;changeBQ(n)}function changeBQ(e){var t="";currentBQ=e,dstcl=[],seldstcl=[],$.getJSON(rootreqstr+"getservices?sRef="+encodeURIComponent(e),function(e){var n=e.services;currentCH=null;var r=0;if($.each(n,function(e,n){dstcl.push(n);var s=n.servicename,o="1"===n.ismarker?markerstr:"";t+="<li class='ui-widget-content' id='"+r+"'><div class='handle'><span class='ui-icon ui-icon-carat-2-n-s'></span></div>"+s+o+"</li>",r++}),$("#bqs").empty(),r>0){$("#bqs").append(t),$("#bqs").selectable().children().first().addClass("ui-selected");var s=$("#bqs").selectable().children().first().attr("id");seldstcl.push(s)}SetDestCHButtons()})}function changeCH(e){currentCH=e.value}function changeProvider(e){$("#btnaddp").prop("disabled",1!==cType),currentProv=e;var t="";srccl=[],selsrccl=[],SetCHButtons(),$.getJSON("/api/getservices?sRef="+e,function(e){var n=e.services;$.each(n,function(e,n){var r=n.servicename;t+="<li class='ui-widget-content'>"+r+"</li>",srccl.push(n)}),$("#channels").empty(),$("#channels").append(t)})}function searchChannel(e){var t=e.toLowerCase();$("#channels li").each(function(){-1!==$(this).html().toLowerCase().indexOf(t)?$(this).show():$(this).hide()}),$("#channels .ui-selected").removeClass("ui-selected"),selsrccl=[],SetCHButtons()}function addprovider(){$.getJSON(rootreqstr+"addprovidertobouquetlist?sProviderRef="+currentProv+"&mode="+Mode,function(e){var t=e.Result;t[0]&&showError(t[1],t[0]),BQELoadBQ()})}function addchannel(){var e=[];$.each(selsrccl,function(t,n){var r=parseInt(n);e.push(srccl[r].servicereference)});var t=[],n="";if(seldstcl.length>0){var r=seldstcl[0],s=parseInt(r);n=dstcl[s].servicereference}$.each(e,function(e,r){t.push($.getJSON(rootreqstr+"addservicetobouquet?sBouquetRef="+encodeURIComponent(currentBQ)+"&sRef="+encodeURIComponent(r)+"&sRefBefore="+encodeURIComponent(n),function(){}))}),0!==t.length&&$.when.apply($,t).then(function(){changeBQ(currentBQ)})}function addalter(){return void NOTI()}function movec(e){var t=[],n=!1;if(0!==e.length&&e.length===dstcl.length){for(var r=0;r<e.length;r++){var s=parseInt(e[r]);if(n&&r>s)break;r!==s&&(t.push(encodeURIComponent(dstcl[s].servicereference)+"&mode="+Mode+"&position="+r),n=!0)}var o=[];$.each(t,function(e,t){o.push($.getJSON(rootreqstr+"moveservice?sBouquetRef="+encodeURIComponent(currentBQ)+"&sRef="+t,function(){}))}),0!==o.length&&$.when.apply($,o).then(function(){changeBQ(currentBQ)})}}function movebq(e){var t=[],n=!1;if(0!==e.length&&e.length===dstbl.length){for(var r=0;r<e.length;r++){var s=parseInt(e[r]);if(n&&r>s)break;r!==s&&(t.push(encodeURIComponent(dstbl[s].servicereference)+"&mode="+Mode+"&position="+r),n=!0)}var o=[];$.each(t,function(e,t){o.push($.getJSON(rootreqstr+"movebouquet?sBouquetRef="+t,function(){}))}),0!==o.length&&$.when.apply($,o).then(function(){BQELoadBQ()})}}function delc(){if(!(seldstcl.length<1)){var e=[],t=[];$.each(seldstcl,function(n,r){var s=parseInt(r);e.push(dstcl[s].servicename),t.push(dstcl[s].servicereference)});var n=e.join();if(confirm(tstr_bqe_del_channel_question+"\n"+n+" ?")!==!1){var r=[];$.each(t,function(e,t){r.push($.getJSON(rootreqstr+"removeservice?sBouquetRef="+encodeURIComponent(currentBQ)+"&sRef="+encodeURIComponent(t)+"&mode="+Mode,function(){}))}),0!==r.length&&$.when.apply($,r).then(function(){changeBQ(currentBQ)})}}}function delbq(){if(1===seldstbl.length){var e=parseInt(seldstbl[0]),t=dstbl[e].servicename,n=dstbl[e].servicereference;confirm(tstr_bqe_del_bouquet_question+"\n"+t+" ?")!==!1&&$.getJSON(rootreqstr+"removebouquet?sBouquetRef="+encodeURIComponent(n)+"&mode="+Mode,function(e){var t=e.Result;t[0]&&showError(t[1],t[0]),BQELoadBQ()})}}function addbq(){var e=prompt(tstr_bqe_name_bouquet+":");e.length&&$.getJSON(rootreqstr+"addbouquet?name="+encodeURIComponent(e)+"&mode="+Mode,function(e){var t=e.Result;t[0]&&showError(t[1],t[0]),BQELoadBQ()})}function addm(){var e=prompt(tstr_bqe_name_marker+":");if(e.length){var t="";if(seldstcl.length>0){var n=seldstcl[0],r=parseInt(n);t=dstcl[r].servicereference}$.getJSON(rootreqstr+"addmarkertobouquet?sBouquetRef="+encodeURIComponent(currentBQ)+"&Name="+encodeURIComponent(e)+"&sRefBefore="+encodeURIComponent(t),function(e){var t=e.Result;t[0]&&showError(t[1],t[0]),changeBQ(currentBQ)})}}function renbq(){if(1===seldstbl.length){var e=parseInt(seldstbl[0]),t=dstbl[e].servicename,n=dstbl[e].servicereference,r=prompt(tstr_bqe_rename_bouquet+":",t);r&&r!=t&&$.getJSON(rootreqstr+"renameservice?sRef="+encodeURIComponent(n)+"&mode="+Mode+"&newName="+encodeURIComponent(r),function(e){var t=e.Result;t[0]&&showError(t[1],t[0]),BQELoadBQ()})}}function renmg(){if(1===seldstcl.length){var e=parseInt(seldstcl[0]);if("0"!==dstcl[e].ismarker){var t=dstcl[e].servicename,n=dstcl[e].servicereference,r=prompt(tstr_bqe_rename_marker+":",t);if(r&&r!=t){var s="";e++,e<dstcl.length&&(s=dstcl[e].servicereference),$.getJSON(rootreqstr+"renameservice?sBouquetRef="+encodeURIComponent(currentBQ)+"&sRef="+encodeURIComponent(n)+"&newName="+encodeURIComponent(r)+"&sRefBefore="+encodeURIComponent(s),function(e){var t=e.Result;t[0]&&showError(t[1],t[0]),changeBQ(currentBQ)})}}}}function SetDestCHButtons(){var e=seldstcl.length>0;if($("#btncdel").prop("disabled",!e),$("#btnmadd").prop("disabled",!e),e=1===seldstcl.length){var t=seldstcl[0],n=parseInt(t);e="1"===dstcl[n].ismarker}$("#btnmgren").prop("disabled",!e)}function SetCHButtons(){var e=selsrccl.length>0;$("#btnaddc").prop("disabled",!e),$("#btnadda").prop("disabled",!e)}function SetBQButtons(){var e=1===seldstbl.length;$("#btnbren").prop("disabled",!e),$("#btnbdel").prop("disabled",!e)}function NOTI(){alert("NOT implemented YET")}function BQEBackup(){var e=prompt(tstr_bqe_filename+":","bouquets_backup");e&&$.getJSON(rootreqstr+"backup?Filename="+e,function(e){var t=e.Result;if(t[0]===!1)showError(t[1],t[0]);else{var n="/bouqueteditor/tmp/"+t[1];window.open(n,"Download")}})}function BQEDoRestore(e){e&&$.getJSON(rootreqstr+"restore?Filename="+e,function(e){console.log(e);var t=e.Result;showError(t[1],t[0])})}function BQERestore(){$("#rfile").trigger("click")}function prepareRestore(e){var t=e.val();t=t.replace("C:\\fakepath\\",""),confirm(tstr_bqe_restore_question+" ( "+t+") ?")!==!1&&($("form#uploadrestore").unbind("submit"),$("form#uploadrestore").submit(function(e){var t=new FormData(this);$.ajax({url:"/bouqueteditor/uploadrestore",type:"POST",data:t,mimeType:"multipart/form-data",contentType:!1,cache:!1,processData:!1,dataType:"json",success:function(e,t){var n=e.Result;n[0]?BQEDoRestore(n[1]):showError("Upload File: "+t)},error:function(e,t,n){showError("Upload File Error: "+n)}}),e.preventDefault();try{e.unbind()}catch(e){}}),$("form#uploadrestore").submit())}function InitPage(){showError(""),$("#btn0").click(function(){BQELoadTVR(0)}),$("#btn1").click(function(){BQELoadTVR(1)}),$("#btn2").click(function(){BQELoadSatellites()}),$("#btn3").click(function(){BQELoadProvider()}),$("#btn4").click(function(){BQELoadAll()}),$("#btn5").click(function(){BQELoadBQ()}),$("#btn6").click(function(){BQEBackup()}),$("#btn7").click(function(){BQERestore()}),$("#tb1").buttonset(),$("#tb2").buttonset(),$("#tb3").buttonset(),$("#provider").selectable({selected:function(e,t){$(t.selected).addClass("ui-selected").siblings().removeClass("ui-selected"),changeProvider(t.selected.id)}}),$("#channels").selectable({stop:function(){var e=[];$(".ui-selected",this).each(function(){var t=$("#channels li").index(this);e.push(t)}),selsrccl=e,SetCHButtons()}}),$("#bqs").sortable({handle:".handle",update:function(){var e=$(this).sortable("toArray");movec(e)}}).selectable({filter:"li",cancel:".handle",stop:function(){var e=[];$(".ui-selected",this).each(function(){var t=$("#bqs li").index(this);e.push(t)}),seldstcl=e,console.log(e),SetDestCHButtons()}}),$("#bql").sortable({handle:".handle",update:function(){var e=$(this).sortable("toArray");movebq(e)}}).selectable({filter:"li",cancel:".handle",stop:function(){var e=[];$(".ui-selected",this).each(function(){var t=$("#bql li").index(this);e.push(t)}),seldstbl=e,SetBQButtons(),1===e.length&&changeBQidx(e[0])}}),$("#searchch").focus(function(){"..."==$(this).val()&&$(this).val("")}),$("#searchch").keyup(function(){$(this).data("val")!=this.value&&searchChannel(this.value),$(this).data("val",this.value)}),$("#searchch").blur(function(){""==$(this).val()&&$(this).val("...")}),SetBQButtons(),$("#btnaddc").prop("disabled",!0),$("#btnadda").prop("disabled",!0),$("#btnaddp").prop("disabled",!0),$("#btnmadd").prop("disabled",!0),$("#btnmgren").prop("disabled",!0),BQELoadTVR(3),$("#rfile").change(function(){prepareRestore($(this))})}function showError(e,t){t="undefined"!=typeof t?t:"False",$("#success").text(""),$("#error").text(""),t===!0&&(t="True"),"True"===t?$("#success").text(e):$("#error").text(e),""!==e?$("#errorbox").show():$("#errorbox").hide()}var Mode=0,cType=1,currentBQ=null,currentProv=null,srccl=[],dstbl=[],dstcl=[],seldstbl=[],seldstcl=[],selsrccl=[],markerstr="<span style='float:right'>(M)</span>",rootreqstr="/bouqueteditor/api/";